# ---------------------------------------------------
# Titanic Survival Predictor — Final Cinematic Edition
# ---------------------------------------------------

packages <- c("shiny", "tidyverse", "bslib", "shinyjs")
new_pkgs <- packages[!(packages %in% installed.packages()[, "Package"])]
if (length(new_pkgs)) install.packages(new_pkgs)

library(shiny)
library(tidyverse)
library(bslib)
library(shinyjs)

# --- Logistic model setup ---
titanic <- as.data.frame(Titanic)
titanic_full <- titanic[rep(1:nrow(titanic), titanic$Freq), 1:4]
titanic_full$Survived_bin <- ifelse(titanic_full$Survived == "Yes", 1, 0)
model <- glm(Survived_bin ~ Class + Sex + Age, data = titanic_full, family = binomial)

# ---------------------------------------------------
# UI
# ---------------------------------------------------
ui <- fluidPage(
  useShinyjs(),
  theme = bs_theme(
    bootswatch = "flatly",
    base_font = font_google("Open Sans"),
    heading_font = font_google("Roboto Slab"),
    primary = "#154360"
  ),
  
  tags$head(tags$style(HTML("
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #e9f2ff 0%, #f9fbff 100%);
    }
    /* --- Fade animations --- */
    .fadeIn {animation: fadeIn 1.2s ease forwards;}
    @keyframes fadeIn {from {opacity: 0;} to {opacity: 1;}}
    .fadeOut {animation: fadeOut 0.8s ease forwards;}
    @keyframes fadeOut {from {opacity: 1;} to {opacity: 0; transform: translateY(-20px);}}

    /* --- Welcome screen --- */
    #welcomeScreen {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center; z-index: 10;
      width: 100%; height: 100%;
      background: linear-gradient(180deg, #eef4ff, #f9fbff);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      transition: opacity 0.8s ease;
    }
    .welcomeTitle {
      font-size: 45px; color: #0e3e72;
      font-weight: 800; margin-bottom: 10px;
      animation: floatTitle 3s ease-in-out infinite alternate;
    }
    @keyframes floatTitle {from {transform: translateY(0);} to {transform: translateY(-6px);}}
    .welcomeSubtitle {color: #555; font-size: 18px; margin-bottom: 40px;}
    .launch-btn {
      background: linear-gradient(90deg, #154360, #2471A3);
      color: white; font-weight: bold; font-size: 18px;
      padding: 14px 40px; border-radius: 30px; border: none;
      cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.4s ease;
    }
    .launch-btn:hover {transform: scale(1.08); box-shadow: 0 8px 25px rgba(21,67,96,0.35);}

    /* --- Main container --- */
    .main-container {
      height: 100vh; width: 100vw; position: relative;
      display: none; opacity: 0; transition: opacity 1s ease;
    }
    .main-container.active {display: block; opacity: 1;}

    /* --- Input card --- */
    #inputCard {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      width: 400px; padding: 30px; border-radius: 12px;
      background: #fff; box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      transition: all 1s ease-in-out; z-index: 2;
    }
    #inputCard.shrink {
      left: 28%; transform: translate(-50%, -50%) scale(0.9);
    }

    /* --- Results panel --- */
    #resultPanel {
      opacity: 0; transform: translateX(120px);
      transition: all 1s ease-in-out;
      position: absolute; top: 50%; right: 8%;
      transform-origin: center; transform: translateY(-50%);
      width: 45%;
    }
    #resultPanel.show {opacity: 1; transform: translateY(-50%) translateX(0);}

    .probBox {
      font-size: 55px; font-weight: 800; color: white;
      text-align: center; padding: 25px; border-radius: 12px;
      margin: 15px 0; box-shadow: 0 5px 25px rgba(0,0,0,0.2);
      animation: scalePop 0.9s ease forwards;
    }
    @keyframes scalePop {0% {opacity: 0; transform: scale(0.5);} 60% {opacity: 1; transform: scale(1.1);} 100% {transform: scale(1);}}
    .interpretation {animation: slideUp 1.2s ease forwards;}
    @keyframes slideUp {from {opacity: 0; transform: translateY(25px);} to {opacity: 1; transform: translateY(0);}}

    /* --- Sidebar --- */
    #sidebar {
      position: fixed; left: -280px; top: 0; width: 260px; height: 100%;
      background: rgba(255,255,255,0.7); backdrop-filter: blur(12px);
      box-shadow: 4px 0 20px rgba(0,0,0,0.1);
      padding: 30px; transition: left 0.6s ease;
      z-index: 20;
    }
    #sidebar.show {left: 0;}
    .sidebar-btn {
      position: absolute; top: 20px; left: 20px;
      background: #154360; color: white;
      border: none; padding: 10px 14px; border-radius: 8px;
      font-size: 20px; cursor: pointer; z-index: 25;
      transition: all 0.3s ease;
    }
    .sidebar-btn:hover {background: #1A5276;}
    .sidebar-section {margin-top: 40px;}
    .sidebar-section h5 {color: #154360; font-weight: 700;}
    .sidebar-section p {color: #333; font-size: 14px;}
  "))),
  
  # --- WELCOME SCREEN ---
  div(
    id = "welcomeScreen",
    h1("Titanic Survival Predictor", class="welcomeTitle"),
    p("Experience data, design, and destiny.", class="welcomeSubtitle"),
    actionButton("launchApp", "Launch Predictor", class="launch-btn")
  ),
  
  # --- MAIN APP ---
  div(
    id = "mainDiv", class="main-container",
    actionButton("toggleSidebar", "☰", class="sidebar-btn"),
    div(
      id = "sidebar",
      div(class="sidebar-section",
          h5("About"), p("This predictor uses a logistic regression model trained on Titanic passenger data.")),
      div(class="sidebar-section",
          h5("How it Works"), p("The model estimates survival probability based on passenger class, gender, and age.")),
      div(class="sidebar-section",
          h5("Credits"), p("Built with R Shiny, styled with Bootstrap and custom CSS."))
    ),
    
    div(
      id = "inputCard",
      h3("Passenger Details", style="text-align:center; color:#154360; font-weight:bold;"),
      selectInput("class", "Passenger Class:", c("1st","2nd","3rd","Crew")),
      selectInput("sex", "Gender:", c("Male","Female")),
      selectInput("age", "Age Group:", c("Child","Adult")),
      br(),
      actionButton("predict_btn","Predict",class="btn btn-primary w-100"),
      br(),br(),
      p("Powered by a logistic regression model trained on Titanic passenger data.",
        style="font-size:13px; text-align:center; color:#777; margin:0;")
    ),
    
    div(
      id = "resultPanel",
      h3("Predicted Probability of Survival", style="color:#154360; font-weight:bold;"),
      uiOutput("probabilityBox"),
      br(),
      h4("Interpretation", style="color:#154360;"),
      uiOutput("interpretationBox"),
      br()
    )
  )
)

# ---------------------------------------------------
# Server
# ---------------------------------------------------
server <- function(input, output, session) {
  predict_survival <- function(class, sex, age){
    new_data <- data.frame(Class=class, Sex=sex, Age=age)
    prob <- predict(model, newdata=new_data, type="response")
    return(prob)
  }
  
  # Welcome → main
  observeEvent(input$launchApp,{
    runjs("
      $('#welcomeScreen').addClass('fadeOut');
      setTimeout(function(){
        $('#welcomeScreen').hide();
        $('#mainDiv').addClass('active fadeIn');
      },800);
    ")
  })
  
  # Sidebar toggle
  observeEvent(input$toggleSidebar,{
    runjs("$('#sidebar').toggleClass('show');")
  })
  
  # Predict
  observeEvent(input$predict_btn,{
    runjs("
      if (!$('#resultPanel').hasClass('show')) {
        $('#inputCard').addClass('shrink');
        setTimeout(function(){$('#resultPanel').addClass('show');},600);
      }
    ")
    prob <- predict_survival(input$class, input$sex, input$age)
    percent <- round(prob * 100,2)
    color <- ifelse(prob>0.5,"#1ABC9C","#E74C3C")
    
    output$probabilityBox <- renderUI({
      div(class="probBox", style=paste0("background-color:",color,";"), paste0(percent,"%"))
    })
    output$interpretationBox <- renderUI({
      div(class="interpretation",
          if(prob>0.5)
            "This passenger has a high likelihood of surviving based on the selected characteristics."
          else
            "This passenger has a lower likelihood of survival based on the selected characteristics."
      )
    })
  })
}

# ---------------------------------------------------
# Run
# ---------------------------------------------------
shinyApp(ui=ui, server=server)
